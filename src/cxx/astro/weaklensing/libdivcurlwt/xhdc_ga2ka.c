#include <stdlib.h>
#include <stdio.h>
#include <math.h>

#define N 512
#define pi 3.1415926535898
#define rh 0.18
#define Iti 20
#define Itn 7
#define Itl 3
#define T 2002

#define SWAP(a,b) tempr=(a);(a)=(b);(b)=tempr

void tfodan2d(float c[2][N][N],float ddn[2][N][N])
{
 int j,j1,j2,i1,i2,e1,e2,l1,l2;
 float k1[N],k2[N];
 float d[2][N][N];
 float h[2][5]={{-1./8.,1./4.,3./4.,1./4.,-1./8.},{0.,-1./4.,3./4.,3./4.,-1./4.}};
 float g[2][5]={{0.,0.,-1./4.,1./2.,-1./4},{0.,1./8.,-3./8.,3./8.,-1./8.}};
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   k1[i1]=c[0][i1][i2];
   k2[i1]=c[1][i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i1=0;i1<j;i1++) {
    d[0][i1][i2]=-1./4.*k1[(2*i1-1+2*j)%(2*j)]+3./4.*k1[2*i1]+3./4.*k1[2*i1+1]-1./4.*k1[(2*i1+2)%(2*j)];
    d[0][j+i1][i2]=1./8.*k1[(2*i1-1+2*j)%(2*j)]-3./8.*k1[2*i1]+3./8.*k1[2*i1+1]-1./8.*k1[(2*i1+2)%(2*j)];
    d[1][i1][i2]=-1./8.*k2[(2*i1-2+2*j)%(2*j)]+1./4.*k2[(2*i1-1+2*j)%(2*j)]+3./4.*k2[2*i1]+1./4.*k2[2*i1+1]-1./8.*k2[(2*i1+2)%(2*j)];
    d[1][j+i1][i2]=-1./4.*k2[2*i1]+1./2.*k2[2*i1+1]-1./4.*k2[(2*i1+2)%(2*j)];
   }
   for (i1=0;i1<j;i1++) {
    k1[i1]=d[0][i1][i2];
    k2[i1]=d[1][i1][i2];
   }
  }
 }
 for (i1=0;i1<N;i1++) {
  for (i2=0;i2<N;i2++) {
   k1[i2]=d[0][i1][i2];
   k2[i2]=d[1][i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i2=0;i2<j;i2++) {
    d[0][i1][i2]=-1./8.*k1[(2*i2-2+2*j)%(2*j)]+1./4.*k1[(2*i2-1+2*j)%(2*j)]+3./4.*k1[2*i2]+1./4.*k1[2*i2+1]-1./8.*k1[(2*i2+2)%(2*j)];
    d[0][i1][j+i2]=-1./4.*k1[2*i2]+1./2.*k1[2*i2+1]-1./4.*k1[(2*i2+2)%(2*j)];
    d[1][i1][i2]=-1./4.*k2[(2*i2-1+2*j)%(2*j)]+3./4.*k2[2*i2]+3./4.*k2[2*i2+1]-1./4.*k2[(2*i2+2)%(2*j)];
    d[1][i1][j+i2]=1./8.*k2[(2*i2-1+2*j)%(2*j)]-3./8.*k2[2*i2]+3./8.*k2[2*i2+1]-1./8.*k2[(2*i2+2)%(2*j)];
   }
   for (i2=0;i2<j;i2++) {
    k1[i2]=d[0][i1][i2];
    k2[i2]=d[1][i1][i2];
   }
  }
 }
 for (j1=N/2;j1>0;j1=j1/2) {
  for (j2=N/2;j2>0;j2=j2/2) {
   for (i1=0;i1<j1;i1++) {
    for (i2=0;i2<j2;i2++) {
     ddn[0][j1+i1][j2+i2]=(j2*d[0][j1+i1][j2+i2]-j1*d[1][j1+i1][j2+i2])/(j1*j1+j2*j2);
     ddn[1][j1+i1][j2+i2]=(j1*d[0][j1+i1][j2+i2]+j2*d[1][j1+i1][j2+i2])/(j1*j1+j2*j2);
    }
   }
  }
 }
 for (i1=1;i1<N;i1++) {
  ddn[0][i1][0]=d[1][i1][0];
  ddn[1][i1][0]=d[0][i1][0];
  ddn[0][0][i1]=d[0][0][i1];
  ddn[1][0][i1]=d[1][0][i1];
 }
 ddn[0][0][0]=d[0][0][0];
 ddn[1][0][0]=d[1][0][0];
}
    
void tfodaninv2d(float c[2][N][N],float ddn[2][N][N])
{
 int j,j1,j2,i1,i2,e1,e2,l;
 float cw[2][N][N];
 float h[2][5]={{1./2.,1.,1./2.,0.,0.},{1./4.,3./4.,3./4.,1./4.,0.}};
 float g[2][5]={{-1./4.,-1./2.,3./2.,-1./2.,-1./4.},{-1./2.,-3./2.,3./2.,1./2.,0.}};
 
 c[0][0][0]=ddn[0][0][0];
 c[1][0][0]=ddn[1][0][0];
 for (i1=1;i1<N;i1++) {
  c[1][i1][0]=ddn[0][i1][0];
  c[0][i1][0]=ddn[1][i1][0];
  c[0][0][i1]=ddn[0][0][i1];
  c[1][0][i1]=ddn[1][0][i1];
 }
 for (j1=N/2;j1>0;j1=j1/2) {
  for (j2=N/2;j2>0;j2=j2/2) {
   for (i1=0;i1<j1;i1++) {
    for (i2=0;i2<j2;i2++) {
     c[0][j1+i1][j2+i2]=j2*ddn[0][j1+i1][j2+i2]+j1*ddn[1][j1+i1][j2+i2];
     c[1][j1+i1][j2+i2]=-j1*ddn[0][j1+i1][j2+i2]+j2*ddn[1][j1+i1][j2+i2];
    }
   }
  }
 }
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   cw[0][i1][i2]=0.;
   cw[1][i1][i2]=0.;
  }
 }
 for (i1=0;i1<N;i1++) {
  for (j=1;j<N;j=2*j) {
   for (i2=0;i2<j;i2++) {
    for (l=-1;l<4;l++) {
     cw[0][i1][(2*i2+l+2*j)%(2*j)]=h[0][l+1]*c[0][i1][i2]+g[0][l+1]*c[0][i1][j+i2]+cw[0][i1][(2*i2+l+2*j)%(2*j)];
     cw[1][i1][(2*i2+l+2*j)%(2*j)]=h[1][l+1]*c[1][i1][i2]+g[1][l+1]*c[1][i1][j+i2]+cw[1][i1][(2*i2+l+2*j)%(2*j)];
    }
   }
   for (i2=0;i2<2*j;i2++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
 for (i2=0;i2<N;i2++) {
  for (j=1;j<N;j=2*j) {
   for (i1=0;i1<j;i1++) {
    for (l=-1;l<4;l++) {
     cw[0][(2*i1+l+2*j)%(2*j)][i2]=h[1][l+1]*c[0][i1][i2]+g[1][l+1]*c[0][j+i1][i2]+cw[0][(2*i1+l+2*j)%(2*j)][i2];
     cw[1][(2*i1+l+2*j)%(2*j)][i2]=h[0][l+1]*c[1][i1][i2]+g[0][l+1]*c[1][j+i1][i2]+cw[1][(2*i1+l+2*j)%(2*j)][i2];
    }
   }
   for (i1=0;i1<2*j;i1++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
}

void tfogan2d(float c[2][N][N],float dg[2][N][N])
{
 int j,j1,j2,i1,i2,e1,e2,l1,l2;
 float k1[N],k2[N];
 float d[2][N][N];
 float h[2][5]={{-1./8.,1./4.,3./4.,1./4.,-1./8.},{0.,-1./4.,3./4.,3./4.,-1./4.}};
 float g[2][5]={{0.,0.,-1./4.,1./2.,-1./4},{0.,1./8.,-3./8.,3./8.,-1./8.}};

 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   k1[i1]=c[0][i1][i2];
   k2[i1]=c[1][i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i1=0;i1<j;i1++) {
    d[0][i1][i2]=-1./8.*k1[(2*i1-2+2*j)%(2*j)]+1./4.*k1[(2*i1-1+2*j)%(2*j)]+3./4.*k1[2*i1]+1./4.*k1[2*i1+1]-1./8.*k1[(2*i1+2)%(2*j)];
    d[0][j+i1][i2]=-1./4.*k1[2*i1]+1./2.*k1[2*i1+1]-1./4.*k1[(2*i1+2)%(2*j)];
    d[1][i1][i2]=-1./4.*k2[(2*i1-1+2*j)%(2*j)]+3./4.*k2[2*i1]+3./4.*k2[2*i1+1]-1./4.*k2[(2*i1+2)%(2*j)];
    d[1][j+i1][i2]=1./8.*k2[(2*i1-1+2*j)%(2*j)]-3./8.*k2[2*i1]+3./8.*k2[2*i1+1]-1./8.*k2[(2*i1+2)%(2*j)];
   }
   for (i1=0;i1<j;i1++) {
    k1[i1]=d[0][i1][i2];
    k2[i1]=d[1][i1][i2];
   }
  }
 }
 for (i1=0;i1<N;i1++) {
  for (i2=0;i2<N;i2++) {
   k1[i2]=d[0][i1][i2];
   k2[i2]=d[1][i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i2=0;i2<j;i2++) {
    d[0][i1][i2]=-1./4.*k1[(2*i2-1+2*j)%(2*j)]+3./4.*k1[2*i2]+3./4.*k1[2*i2+1]-1./4.*k1[(2*i2+2)%(2*j)];
    d[0][i1][j+i2]=1./8.*k1[(2*i2-1+2*j)%(2*j)]-3./8.*k1[2*i2]+3./8.*k1[2*i2+1]-1./8.*k1[(2*i2+2)%(2*j)];
    d[1][i1][i2]=-1./8.*k2[(2*i2-2+2*j)%(2*j)]+1./4.*k2[(2*i2-1+2*j)%(2*j)]+3./4.*k2[2*i2]+1./4.*k2[2*i2+1]-1./8.*k2[(2*i2+2)%(2*j)];
    d[1][i1][j+i2]=-1./4.*k2[2*i2]+1./2.*k2[2*i2+1]-1./4.*k2[(2*i2+2)%(2*j)];
   }
   for (i2=0;i2<j;i2++) {
    k1[i2]=d[0][i1][i2];
    k2[i2]=d[1][i1][i2];
   }
  }
 }
 for (j1=N/2;j1>0;j1=j1/2) {
  for (j2=N/2;j2>0;j2=j2/2) {
   for (i1=0;i1<j1;i1++) {
    for (i2=0;i2<j2;i2++) {
     dg[0][j1+i1][j2+i2]=(j1*d[0][j1+i1][j2+i2]+j2*d[1][j1+i1][j2+i2])/(j1*j1+j2*j2);
     dg[1][j1+i1][j2+i2]=(j2*d[0][j1+i1][j2+i2]-j1*d[1][j1+i1][j2+i2])/(j1*j1+j2*j2);
    }
   }
  }
 }
 for (i1=1;i1<N;i1++) {
  dg[0][i1][0]=d[0][i1][0];
  dg[1][i1][0]=d[1][i1][0];
  dg[0][0][i1]=d[1][0][i1];
  dg[1][0][i1]=d[0][0][i1];
 }
 dg[0][0][0]=d[0][0][0];
 dg[1][0][0]=d[1][0][0];
}

void tfoganinv2d(float c[2][N][N],float dg[2][N][N])
{
 int j,j1,j2,i1,i2,e1,e2,l;
 float cw[2][N][N];
 float h[2][5]={{1./2.,1.,1./2.,0.,0.},{1./4.,3./4.,3./4.,1./4.,0.}};
 float g[2][5]={{-1./4.,-1./2.,3./2.,-1./2.,-1./4.},{-1./2.,-3./2.,3./2.,1./2.,0.}};
 
 c[0][0][0]=dg[0][0][0];
 c[1][0][0]=dg[1][0][0];
 for (i1=1;i1<N;i1++) {
  c[0][i1][0]=dg[0][i1][0];
  c[1][i1][0]=dg[1][i1][0];
  c[0][0][i1]=dg[1][0][i1];
  c[1][0][i1]=dg[0][0][i1];
 }
 for (j1=N/2;j1>0;j1=j1/2) {
  for (j2=N/2;j2>0;j2=j2/2) {
   for (i1=0;i1<j1;i1++) {
    for (i2=0;i2<j2;i2++) {
     c[0][j1+i1][j2+i2]=j1*dg[0][j1+i1][j2+i2]+j2*dg[1][j1+i1][j2+i2];
     c[1][j1+i1][j2+i2]=j2*dg[0][j1+i1][j2+i2]-j1*dg[1][j1+i1][j2+i2];
    }
   }
  }
 }
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   cw[0][i1][i2]=0.;
   cw[1][i1][i2]=0.;
  }
 }
 for (i1=0;i1<N;i1++) {
  for (j=1;j<N;j=2*j) {
   for (i2=0;i2<j;i2++) {
    for (l=-1;l<4;l++) {
     cw[0][i1][(2*i2+l+2*j)%(2*j)]=h[1][l+1]*c[0][i1][i2]+g[1][l+1]*c[0][i1][j+i2]+cw[0][i1][(2*i2+l+2*j)%(2*j)];
     cw[1][i1][(2*i2+l+2*j)%(2*j)]=h[0][l+1]*c[1][i1][i2]+g[0][l+1]*c[1][i1][j+i2]+cw[1][i1][(2*i2+l+2*j)%(2*j)];
    }
   }
   for (i2=0;i2<2*j;i2++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
 for (i2=0;i2<N;i2++) {
  for (j=1;j<N;j=2*j) {
   for (i1=0;i1<j;i1++) {
    for (l=-1;l<4;l++) {
     cw[0][(2*i1+l+2*j)%(2*j)][i2]=h[0][l+1]*c[0][i1][i2]+g[0][l+1]*c[0][j+i1][i2]+cw[0][(2*i1+l+2*j)%(2*j)][i2];
     cw[1][(2*i1+l+2*j)%(2*j)][i2]=h[1][l+1]*c[1][i1][i2]+g[1][l+1]*c[1][j+i1][i2]+cw[1][(2*i1+l+2*j)%(2*j)][i2];
    }
   }
   for (i1=0;i1<2*j;i1++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
}

int laplimpl(float d0[2][N][N],float d2[2][N][N],float nudt,float dx,int It)
{
int j1,j2,i1,i2,t;
float d1[2][N][N],c0[2][N][N],c1[2][N][N],deltau[2][N][N],ddeltau[2][N][N];

 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   d2[0][i1][i2]=0.;
   d2[1][i1][i2]=0.;
  }
 }

 for (t=0;t<It;t++) {
  for (j1=1;j1<N;j1=2*j1) {
   for (i1=0;i1<j1;i1++) {
    for (j2=1;j2<N;j2=2*j2) {
     for (i2=0;i2<j2;i2++) {
      d1[0][j1+i1][j2+i2]=1./(1.+16.*nudt*rh*rh*((float) (j1*j1)+(float) (j2*j2)))*d0[0][j1+i1][j2+i2];
      d1[1][j1+i1][j2+i2]=0.;
      d0[1][j1+i1][j2+i2]=0.;
     }
    }
   }
  }
  for (j1=1;j1<N;j1=2*j1) {
   for (i1=0;i1<j1;i1++) {
    d1[0][j1+i1][0]=1./(1.+16.*nudt*rh*rh*(float) (j1*j1))*d0[0][j1+i1][0];
    d1[0][0][j1+i1]=1./(1.+16.*nudt*rh*rh*(float) (j1*j1))*d0[0][0][j1+i1];
    d1[1][0][j1+i1]=0.;
    d0[1][0][j1+i1]=0.;
    d1[1][j1+i1][0]=0.;
    d0[1][j1+i1][0]=0.;
   }
  }
  d1[0][0][0]=d0[0][0][0];
  d1[1][0][0]=d0[1][0][0];
  tfodaninv2d(c1,d1);
 
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    deltau[0][i1][i2]=(-4.*c1[0][i1][i2]+c1[0][(i1-1+N)%N][i2]+c1[0][i1][(i2-1+N)%N]+c1[0][(i1+1)%N][i2]+c1[0][i1][(i2+1)%N])/dx/dx;
    deltau[1][i1][i2]=(-4.*c1[1][i1][i2]+c1[1][(i1-1+N)%N][i2]+c1[1][i1][(i2-1+N)%N]+c1[1][(i1+1)%N][i2]+c1[1][i1][(i2+1)%N])/dx/dx;
   }
  }
  tfodan2d(deltau,ddeltau);
  
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    d0[0][i1][i2]=d0[0][i1][i2]-d1[0][i1][i2]+nudt*ddeltau[0][i1][i2];
    d0[1][i1][i2]=d0[1][i1][i2]-d1[1][i1][i2]+nudt*ddeltau[1][i1][i2];
    d2[0][i1][i2]=d2[0][i1][i2]+d1[0][i1][i2];
    d2[1][i1][i2]=d2[1][i1][i2]+d1[1][i1][i2];
   }
  }
 }
}

void tfo0an2d(float c[N][N],float d[N][N])
{
 int j,j1,j2,i1,i2;
 float k1[N];
 float h[2][5]={{-1./8.,1./4.,3./4.,1./4.,-1./8.},{0.,-1./4.,3./4.,3./4.,-1./4.}};
 float g[2][5]={{0.,0.,-1./4.,1./2.,-1./4},{0.,1./8.,-3./8.,3./8.,-1./8.}};

 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   k1[i1]=c[i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i1=0;i1<j;i1++) {
    d[i1][i2]=-1./8.*k1[(2*i1-2+2*j)%(2*j)]+1./4.*k1[(2*i1-1+2*j)%(2*j)]+3./4.*k1[2*i1]+1./4.*k1[2*i1+1]-1./8.*k1[(2*i1+2)%(2*j)];
    d[j+i1][i2]=-1./4.*k1[2*i1]+1./2.*k1[2*i1+1]-1./4.*k1[(2*i1+2)%(2*j)];
   }
   for (i1=0;i1<j;i1++) {
    k1[i1]=d[i1][i2];
   }
  }
 }
 for (i1=0;i1<N;i1++) {
  for (i2=0;i2<N;i2++) {
   k1[i2]=d[i1][i2];
  }
  for (j=N/2;j>0;j=j/2) {
   for (i2=0;i2<j;i2++) {
    d[i1][i2]=-1./8.*k1[(2*i2-2+2*j)%(2*j)]+1./4.*k1[(2*i2-1+2*j)%(2*j)]+3./4.*k1[2*i2]+1./4.*k1[2*i2+1]-1./8.*k1[(2*i2+2)%(2*j)];
    d[i1][j+i2]=-1./4.*k1[2*i2]+1./2.*k1[2*i2+1]-1./4.*k1[(2*i2+2)%(2*j)];
   }
   for (i2=0;i2<j;i2++) {
    k1[i2]=d[i1][i2];
   }
  }
 }
}

void tfo01aninv2d(float c[2][N][N],float dg[2][N][N])
{
 int j,j1,j2,i1,i2,e1,e2,l;
 float cw[2][N][N];
 float h[2][5]={{1./2.,1.,1./2.,0.,0.},{1./4.,3./4.,3./4.,1./4.,0.}};
 float g[2][5]={{-1./4.,-1./2.,3./2.,-1./2.,-1./4.},{-1./2.,-3./2.,3./2.,1./2.,0.}};
 
 for (i1=0;i1<N;i1++) {
  for (i2=0;i2<N;i2++) {
   c[0][i1][i2]=dg[0][i1][i2];
   c[1][i1][i2]=dg[1][i1][i2];
  }
 }
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   cw[0][i1][i2]=0.;
   cw[1][i1][i2]=0.;
  }
 }
 for (i1=0;i1<N;i1++) {
  for (j=1;j<N;j=2*j) {
   for (i2=0;i2<j;i2++) {
    for (l=-1;l<4;l++) {
     cw[0][i1][(2*i2+l+2*j)%(2*j)]=h[1][l+1]*c[0][i1][i2]+g[1][l+1]*c[0][i1][j+i2]+cw[0][i1][(2*i2+l+2*j)%(2*j)];
     cw[1][i1][(2*i2+l+2*j)%(2*j)]=h[0][l+1]*c[1][i1][i2]+g[0][l+1]*c[1][i1][j+i2]+cw[1][i1][(2*i2+l+2*j)%(2*j)];
    }
   }
   for (i2=0;i2<2*j;i2++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
 for (i2=0;i2<N;i2++) {
  for (j=1;j<N;j=2*j) {
   for (i1=0;i1<j;i1++) {
    for (l=-1;l<4;l++) {
     cw[0][(2*i1+l+2*j)%(2*j)][i2]=h[0][l+1]*c[0][i1][i2]+g[0][l+1]*c[0][j+i1][i2]+cw[0][(2*i1+l+2*j)%(2*j)][i2];
     cw[1][(2*i1+l+2*j)%(2*j)][i2]=h[1][l+1]*c[1][i1][i2]+g[1][l+1]*c[1][j+i1][i2]+cw[1][(2*i1+l+2*j)%(2*j)][i2];
    }
   }
   for (i1=0;i1<2*j;i1++) {
    c[0][i1][i2]=cw[0][i1][i2];
    cw[0][i1][i2]=0.;
    c[1][i1][i2]=cw[1][i1][i2];
    cw[1][i1][i2]=0.;
   }
  }
 }
}

void hodge(float vn[2][N][N],float d[2][N][N],float vn0[2][N][N],float d0[2][N][N],int It)
{
 int j,i1,i2;
 float c[2][N][N],cn[2][N][N],dn[2][N][N];
double mx;
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   d[0][i1][i2]=d0[0][i1][i2];
   d[1][i1][i2]=d0[1][i1][i2];
   vn[0][i1][i2]=vn[0][i1][i2]-vn0[0][i1][i2];
   vn[1][i1][i2]=vn[1][i1][i2]-vn0[1][i1][i2];
  }
 }
 for (j=0;j<It;j++) {
mx=0.;
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    mx+=vn[0][i1][i2]*vn[0][i1][i2]+vn[1][i1][i2]*vn[1][i1][i2];
   }
  }
printf("|u|(%d)=%e\n",j,mx);

  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
   c[0][i1][i2]=5./8.*(vn[0][i1][i2]+vn[0][(i1+1)%N][i2])-1./8.*(vn[0][(i1-1+N)%N][i2]+vn[0][(i1+2)%N][i2]);
   c[1][i1][i2]=5./8.*(vn[1][i1][i2]+vn[1][i1][(i2+1)%N])-1./8.*(vn[1][i1][(i2-1+N)%N]+vn[1][i1][(i2+2)%N]);
   }
  }
  tfodan2d(c,dn);
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    d[0][i1][i2]=d[0][i1][i2]+dn[0][i1][i2];
    d[1][i1][i2]=d[1][i1][i2]+dn[1][i1][i2];
    if ((i1+i2)!=0) {
     d[1][i1][i2]=d[1][i1][i2]-dn[1][i1][i2];
     dn[1][i1][i2]=0.;
    }
   }
  }
  tfodaninv2d(c,dn);
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    vn[0][i1][i2]=vn[0][i1][i2]-1./2.*(c[0][(i1-1+N)%N][i2]+c[0][i1][i2]);
    vn[1][i1][i2]=vn[1][i1][i2]-1./2.*(c[1][i1][(i2-1+N)%N]+c[1][i1][i2]);
   }
  }
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
   c[0][i1][i2]=5./8.*(vn[0][i1][i2]+vn[0][i1][(i2+1)%N])-1./8.*(vn[0][i1][(i2-1+N)%N]+vn[0][i1][(i2+2)%N]);
   c[1][i1][i2]=5./8.*(vn[1][i1][i2]+vn[1][(i1+1)%N][i2])-1./8.*(vn[1][(i1-1+N)%N][i2]+vn[1][(i1+2)%N][i2]);
   }
  }
  tfogan2d(c,dn);
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    if ((i1+i2)!=0) {
     d[1][i1][i2]=d[1][i1][i2]+dn[0][i1][i2];
    }
    dn[1][i1][i2]=0.;
    if ((i1+i2)==0) dn[0][i1][i2]=0.;
   }
  }
  tfoganinv2d(c,dn);
  for (i2=0;i2<N;i2++) {
   for (i1=0;i1<N;i1++) {
    vn[0][i1][i2]=vn[0][i1][i2]-1./2.*(c[0][i1][(i2-1+N)%N]+c[0][i1][i2]);
    vn[1][i1][i2]=vn[1][i1][i2]-1./2.*(c[1][(i1-1+N)%N][i2]+c[1][i1][i2]);
   }
  }
 }
 /*actualisation de la donnée initiale*/
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   d0[0][i1][i2]=d[0][i1][i2];
   d0[1][i1][i2]=0.;
   dn[0][i1][i2]=d[1][i1][i2];
   dn[1][i1][i2]=0.;
  }
 }
 d0[1][0][0]=d[1][0][0];
 dn[0][0][0]=0.;
 tfodaninv2d(c,d0);
 tfoganinv2d(cn,dn);
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   vn0[0][i1][i2]=0.5*(c[0][(i1-1+N)%N][i2]+c[0][i1][i2])+0.5*(cn[0][i1][(i2-1+N)%N]+cn[0][i1][i2]);
   vn0[1][i1][i2]=0.5*(c[1][i1][(i2-1+N)%N]+c[1][i1][i2])+0.5*(cn[1][(i1-1+N)%N][i2]+cn[1][i1][i2]);
   d0[0][i1][i2]=d[0][i1][i2];
   d0[1][i1][i2]=d[1][i1][i2];
  }
 }
}

float gauss(float x,float y)
{
 float res;
 res=pi*exp(-pi*pi*(x*x+y*y));
 return(res);
}


int i,j,l1,l2,i1,i2,im,jm,t,nbcoef[3],cr,cg,cb;
float x,y,dx=2.*pi/N,dt=0.02,nu=0.00005,seuil=0.6/20000.,seuil2=0.8/5000.,energie,enstrophie;
double mx,min,enr;
float u0[2][N][N],u1[2][N][N],d0[2][N][N],d1[2][N][N],c[2][N][N],c0[2][N][N];

int dim[3]={0,N,N};

int main()
{
 float *g1,*g2;
 FILE *pFile1,*pFile2;

 pFile1=fopen("g1_512_f_512_512.d","rb");
 pFile2=fopen("g2_512_f_512_512.d","rb");
 FILE *sFile1=fopen("k1_512_f_512_512.d","wb");
 FILE *sFile2=fopen("k2_512_f_512_512.d","wb");
 FILE *kap=fopen("kappa.ppm","w");
 
 fprintf(kap,"P6\n%d %d\n255\n",N,N);
 g1=(float*) malloc(sizeof(float)*(N*N));
 g2=(float*) malloc(sizeof(float)*(N*N));

 fread (g1,4,N*N,pFile1);
 fread (g2,4,N*N,pFile2);
 
 mx=0.; min=0.; enr=0.;
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   min=(min+g1[N*i2+i1]-fabs(min-g1[N*i2+i1]))/2.;
   mx=(mx+g1[N*i2+i1]+fabs(mx-g1[N*i2+i1]))/2.;
   enr+=g1[N*i2+i1]*g1[N*i2+i1]+g2[N*i2+i1]*g2[N*i2+i1];
  }
 }
printf("gamma1 :   min=%e;   mx=%e;\n",min,mx);

 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   u0[0][i1][i2]=g1[N*i2+i1];
   u0[1][i1][i2]=g2[N*i2+i1];
   u1[0][i1][i2]=0.;
   u1[1][i1][i2]=0.;
   d1[0][i1][i2]=0.;
   d1[1][i1][i2]=0.;
  }
 }
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   g1[N*i2+i1]=u0[0][i1][i2];
   g2[N*i2+i1]=u0[1][i1][i2];
  }
 }

 hodge(u0,d0,u1,d1,Iti);
 
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   d0[0][i1][i2]=((i1*i2)!=0)*d1[1][i1][i2];
   d0[1][i1][i2]=0.;
   d1[1][i1][i2]=((i1*i2)==0)*d1[1][i1][i2];
  }
 }
 
 tfodaninv2d(c,d1);
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   u1[0][i1][i2]=0.5*(c[0][(i1-1+N)%N][i2]+c[0][i1][i2]);
   u1[1][i1][i2]=0.5*(c[1][i1][(i2-1+N)%N]+c[1][i1][i2]);
  }
 }
 
 tfoganinv2d(c0,d0);
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   u0[0][i1][i2]=0.5*(c0[0][i1][(i2-1+N)%N]+c0[0][i1][i2]);
   u0[1][i1][i2]=0.5*(c0[1][(i1-1+N)%N][i2]+c0[1][i1][i2]);
  }
 }
  
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   g1[N*i2+i1]=u0[0][i1][i2]-u1[0][i1][i2];
   g2[N*i2+i1]=u0[1][i1][i2]-u1[1][i1][i2];
  }
 }
 
 mx=0.; min=0.;
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   min+=g1[N*i2+i1]*g1[N*i2+i1];
   mx+=g2[N*i2+i1]*g2[N*i2+i1];
  }
 }
 printf("mode E = %e;    mode B = %e;\n",min/enr,mx/enr);
 
 mx=0.; min=0.;
 for (i2=0;i2<N;i2++) {
  for (i1=0;i1<N;i1++) {
   min=(min+g2[N*i2+i1]-fabs(min-g2[N*i2+i1]))/2.;
   mx=(mx+g2[N*i2+i1]+fabs(mx-g2[N*i2+i1]))/2.;
  }
 }

printf("kappa :   min=%e;   mx=%e;\n",min,mx);
  for (j=0;j<N;j++) {
   for (i=0;i<N;i++) {
    im=(int) fabs((g2[i+N*j]-min)/mx*255);
    cr=(int) ((255+1.542*im-fabs(255-1.542*im))/2);
    cb=(int) ((255+3*abs(255-im)-abs(255-3*abs(255-im)))/2);
    cg=(cr+cb-abs(cr-cb))/2;
    cg=(255+cg-abs(255-cg))/2;
    fprintf(kap,"%c%c%c", (unsigned char) cr,(unsigned char) cg,(unsigned char) cb);
   }
  }

 
 fwrite(g1,4,N*N,sFile1); fclose (sFile1);
 fwrite(g2,4,N*N,sFile2); fclose (sFile2);
 
 
}






